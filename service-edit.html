<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit AI Service - SyftBox Service Hub</title>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;600;700&family=Roboto:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: #f8fafc;
            color: #334155;
            line-height: 1.6;
        }

        /* Container - This is the main constraint for content width */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header */
        header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #e2e8f0;
            position: sticky;
            top: 0;
            z-index: 40;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
        }

        .header-left {
            display: flex;
            align-items: center;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .main-nav {
            display: flex;
            gap: 24px;
        }

        .nav-tab {
            background: none;
            border: none;
            padding: 8px 12px;
            font-weight: 400;
            font-size: 14px;
            color: #64748b;
            cursor: pointer;
            transition: color 0.2s;
            text-decoration: none;
        }

        .nav-tab:hover {
            color: #4A6FB3;
        }

        .nav-tab.active {
            color: #1e293b;
            font-weight: 500;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
        }

        .logo-text h1 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 2px;
            font-family: 'Rubik', -apple-system, system-ui, sans-serif;
        }

        .logo-text p {
            font-size: 11px;
            color: #64748b;
            font-weight: 400;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            background: white;
            color: #334155;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
        }

        .btn-primary {
            background: #4A6FB3;
            color: white;
            border-color: #4A6FB3;
        }

        .btn-primary:hover {
            background: #3d5a94;
        }

        .btn-success {
            background: #059669;
            color: white;
            border-color: #059669;
        }

        .btn-success:hover {
            background: #047857;
        }

        .user-icon {
            width: 36px;
            height: 36px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        /* Main Content Container */
        .main-content {
            max-width: 1000px;
            margin: 40px auto;
            padding: 0 20px;
        }

        /* Service Header */
        .service-header {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .service-title {
            font-size: 24px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 4px;
            font-family: 'Rubik', -apple-system, system-ui, sans-serif;
        }

        .service-actions {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-top: 16px;
        }

        /* Tab Navigation */
        .tab-navigation {
            background: white;
            border-radius: 12px;
            padding: 8px;
            margin-bottom: 24px;
            display: flex;
            gap: 4px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .tab-button {
            flex: 1;
            padding: 12px 16px;
            border: none;
            background: transparent;
            color: #64748b;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tab-button:hover {
            background: #f1f5f9;
            color: #334155;
        }

        .tab-button.active {
            background: #4A6FB3;
            color: white;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .tab-content.active {
            display: block;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #475569;
            margin-bottom: 8px;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            color: #1e293b;
            background: white;
            transition: all 0.2s;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #4A6FB3;
            box-shadow: 0 0 0 3px rgba(74, 111, 179, 0.1);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }

        .form-help {
            font-size: 13px;
            color: #64748b;
            margin-top: 4px;
        }

        /* Section Title */
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 16px;
            font-family: 'Rubik', -apple-system, system-ui, sans-serif;
        }

        /* Service Type Indicator */
        .service-type-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #f1f5f9;
            border-radius: 8px;
            margin-bottom: 24px;
        }

        .indicator-label {
            font-size: 13px;
            color: #64748b;
        }

        .indicator-value {
            font-size: 13px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 4px;
            background: #dbeafe;
            color: #1d4ed8;
        }

        /* Manage Control Section */
        .access-control-section {
            margin-bottom: 32px;
            padding-bottom: 32px;
            border-bottom: 1px solid #e2e8f0;
        }

        .access-control-section:last-child {
            border-bottom: none;
        }

        /* Service Users */
        .service-users-grid {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 12px;
            align-items: center;
            margin-bottom: 12px;
        }

        .service-users-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 12px;
        }

        .service-user-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .service-user-email {
            font-size: 14px;
            color: #1e293b;
            font-weight: 500;
        }

        .service-user-access {
            font-size: 13px;
            padding: 4px 8px;
            background: #dbeafe;
            color: #1d4ed8;
            border-radius: 4px;
        }

        .btn-remove {
            padding: 4px 8px;
            font-size: 12px;
            background: #fee2e2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .btn-remove:hover {
            background: #fecaca;
            border-color: #fca5a5;
        }

        /* Watched Files Table */
        .watched-files-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }

        .watched-files-table th {
            text-align: left;
            padding: 12px;
            background: #f8fafc;
            font-size: 13px;
            font-weight: 600;
            color: #475569;
            border-bottom: 1px solid #e2e8f0;
        }

        .watched-files-table td {
            padding: 12px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 14px;
        }

        .path-cell {
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #1e293b;
        }

        .user-badge {
            display: inline-block;
            padding: 4px 8px;
            background: #e0f2fe;
            color: #0369a1;
            border-radius: 4px;
            font-size: 12px;
            margin-right: 4px;
        }

        /* File Access Management */
        .file-access-item {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .file-access-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .file-path {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: #1e293b;
            font-weight: 500;
        }

        .file-access-body {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .access-users {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        /* Add Path Form */
        .add-path-form {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 12px;
            margin-top: 16px;
        }

        /* Collective Policies */
        .collective-policies {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-top: 12px;
        }

        .policy-grid {
            display: grid;
            gap: 12px;
            margin-top: 12px;
        }

        .policy-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            gap: 8px;
        }

        .policy-item label {
            flex: 1;
            text-align: left;
        }

        .policy-status {
            font-size: 12px;
            padding: 4px 8px;
            background: #f1f5f9;
            color: #64748b;
            border-radius: 4px;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #64748b;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: #334155;
        }

        .modal-body {
            padding: 20px;
        }

        /* Markdown editor */
        .markdown-toolbar {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .markdown-preview {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 12px;
            margin-top: 8px;
            min-height: 100px;
        }

        /* Tags Input */
        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 8px;
        }

        .tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: #e0f2fe;
            color: #0369a1;
            border-radius: 16px;
            font-size: 13px;
        }

        .tag-remove {
            background: none;
            border: none;
            color: #0369a1;
            cursor: pointer;
            font-size: 16px;
            padding: 0;
            margin-left: 4px;
        }

        .tag-remove:hover {
            color: #dc2626;
        }

        .tag-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .tag-suggestion {
            display: inline-block;
            padding: 4px 10px;
            background: #f1f5f9;
            color: #64748b;
            border-radius: 16px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .tag-suggestion:hover {
            background: #e2e8f0;
        }

        /* Service Type Selection */
        .single-choice-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .single-choice-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .single-choice-item:hover {
            border-color: #cbd5e1;
            background: #f8fafc;
        }

        .single-choice-item.selected {
            border-color: #4A6FB3;
            background: #eff6ff;
        }

        .radio-circle {
            width: 20px;
            height: 20px;
            border: 2px solid #cbd5e1;
            border-radius: 50%;
            margin-top: 2px;
            position: relative;
            flex-shrink: 0;
        }

        .single-choice-item.selected .radio-circle {
            border-color: #4A6FB3;
        }

        .single-choice-item.selected .radio-circle::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 10px;
            background: #4A6FB3;
            border-radius: 50%;
        }

        .choice-text {
            flex: 1;
        }

        .choice-title {
            font-size: 15px;
            font-weight: 500;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .choice-desc {
            font-size: 13px;
            color: #64748b;
        }

        /* Service Configuration */
        .service-config-container {
            margin-top: 20px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .service-config-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .option-card {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .option-card:hover {
            border-color: #cbd5e1;
            background: white;
        }

        .option-card.selected {
            border-color: #4A6FB3;
            background: #eff6ff;
        }

        .option-title {
            font-size: 14px;
            font-weight: 500;
            color: #1e293b;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .option-description {
            font-size: 12px;
            color: #64748b;
        }

        /* Advanced Settings */
        .advanced-settings {
            margin-top: 16px;
            border-top: 1px solid #e2e8f0;
            padding-top: 16px;
        }

        .advanced-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #475569;
        }

        .advanced-arrow {
            transition: transform 0.2s;
        }

        .advanced-arrow.expanded {
            transform: rotate(90deg);
        }

        .advanced-content {
            margin-top: 16px;
            padding-left: 24px;
        }

        .available-services-layout {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .generate-actions {
            display: flex;
            justify-content: center;
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid #e2e8f0;
        }

        .btn-large {
            padding: 12px 24px;
            font-size: 16px;
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
        }

        .tooltip-container {
            position: relative;
            display: inline-block;
        }

        .tooltip-bubble {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1e293b;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            margin-bottom: 8px;
            z-index: 10;
            max-width: 250px;
            white-space: normal;
        }

        .tooltip-container.tooltip-hover:hover .tooltip-bubble {
            display: block;
        }

        .tooltip-bubble::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid #1e293b;
        }

        /* Filter Tags */
        .filter-group {
            margin-top: 12px;
        }

        .filter-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 8px;
        }

        .filter-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: #f1f5f9;
            color: #475569;
            border-radius: 12px;
            font-size: 12px;
            border: 1px solid #e2e8f0;
        }

        .filter-tag-remove {
            background: none;
            border: none;
            color: #64748b;
            cursor: pointer;
            font-size: 14px;
            padding: 0;
            margin-left: 4px;
        }

        .filter-tag-remove:hover {
            color: #dc2626;
        }

        /* Account Menu */
        .account-menu {
            position: relative;
            display: inline-block;
        }
        
        .account-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            min-width: 200px;
            z-index: 50;
            display: none;
            margin-top: 4px;
        }
        
        .account-dropdown.show {
            display: block;
        }
        
        .dropdown-item {
            padding: 12px 16px;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 14px;
            color: #334155;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
        }
        
        .dropdown-item:hover {
            background: #f8fafc;
        }
        
        .dropdown-item:first-child {
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }
        
        .dropdown-item:last-child {
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
        }
        
        .dropdown-divider {
            height: 1px;
            background: #e2e8f0;
            margin: 4px 0;
        }
        
        .payment-status {
            font-size: 12px;
            color: #64748b;
            margin-left: auto;
        }
        
        .payment-status.registered {
            color: #16a34a;
        }
        
        /* Payment Registration Modal */
        .payment-modal-step {
            display: none;
        }
        
        .payment-modal-step.active {
            display: block;
        }
        
        .service-option {
            display: flex;
            align-items: center;
            padding: 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .service-option:hover {
            border-color: #cbd5e1;
            background: #f8fafc;
        }
        
        .service-option.selected {
            border-color: #4A6FB3;
            background: #eff6ff;
        }
        
        .service-option input[type="radio"] {
            margin-right: 12px;
        }
        
        .service-details {
            flex: 1;
        }
        
        .service-name {
            font-weight: 500;
            color: #1e293b;
            margin-bottom: 4px;
        }
        
        .service-url {
            font-size: 13px;
            color: #64748b;
            font-family: 'Courier New', monospace;
        }
        
        .payment-error {
            color: #dc2626;
            font-size: 13px;
            margin-top: 8px;
            display: none;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .main-content {
                padding: 0 16px;
            }

            .service-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }

            .service-actions {
                width: 100%;
                flex-direction: column;
            }

            .service-actions .btn {
                width: 100%;
                justify-content: center;
            }

            .tab-navigation {
                flex-direction: column;
            }

            .service-users-grid {
                grid-template-columns: 1fr;
            }
            
            .account-dropdown {
                right: -20px;
                min-width: 180px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container">
            <div class="header-content">
                <div class="header-left">
                    <div class="logo">
                        <div class="logo-icon"></div>
                        <div class="logo-text">
                            <h1>SyftBox AI Service Hub</h1>
                            <p>The network for collective intelligence</p>
                        </div>
                    </div>
                </div>
                
                <div class="header-right">
                    <nav class="main-nav">
                        <a href="index.html" class="nav-tab">Discover</a>
                        <a href="compose.html" class="nav-tab">Compose</a>
                        <a href="build.html" class="nav-tab active">Build</a>
                    </nav>
                    
                    <div class="header-controls">
                        <div class="account-menu">
                            <button class="btn user-icon" onclick="toggleAccountMenu()">üë§</button>
                            <div class="account-dropdown" id="accountDropdown">
                                <div class="dropdown-item" style="font-weight: 500; pointer-events: none;">
                                    <span id="accountName">Irina</span>
                                    <span class="payment-status" id="paymentStatus">Not registered</span>
                                </div>
                                <div class="dropdown-divider"></div>
                                <button class="dropdown-item" onclick="showPaymentRegistration()" id="registerPaymentBtn">
                                    üí≥ Register Wallet Manager
                                </button>
                                <button class="dropdown-item" onclick="managePaymentService()" id="managePaymentBtn" style="display: none;">
                                    ‚öôÔ∏è Manage Wallet Manager
                                </button>
                                <div class="dropdown-divider"></div>
                                <button class="dropdown-item">
                                    üö™ Sign Out
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content - Everything is contained within this -->
    <div class="main-content">
        <!-- Service Header -->
        <div class="service-header">
            <h1 class="service-title" id="serviceTitle">irina@openmined.org/legal_document_analyzer</h1>
            <div style="color: #6b7280; font-size: 14px; margin-bottom: 16px;" id="serviceStatus">Draft ‚Ä¢ Created 2 hours ago</div>
            <div class="service-actions">
                <button class="btn" onclick="goBack()">‚Üê Back to Services</button>
                <button class="btn btn-success" onclick="publishService()" id="publishBtn">üì§ Publish Service</button>
                <button class="btn" onclick="generateMCPTool()" id="generateMCPBtn" disabled>üîß Generate MCP Tool</button>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-button active" onclick="showTab('metadata')">üìù Metadata</button>
            <button class="tab-button" onclick="showTab('code-generation')">‚öôÔ∏è Code Generation</button>
            <button class="tab-button" onclick="showTab('access-control')">üîê Manage Control</button>
        </div>

        <!-- Metadata Tab -->
        <div class="tab-content active" id="metadata-tab">
            <div class="form-group">
                <label class="form-label">Service Name</label>
                <input type="text" class="form-input" value="irina@openmined.org/legal_document_analyzer" placeholder="Enter service name">
            </div>

            <div class="form-group">
                <label class="form-label">Summary</label>
                <input type="text" class="form-input" id="summaryInput" placeholder="Brief description of your service">
                <div class="form-help">A short one-line summary that appears in service listings</div>
            </div>

            <div class="form-group">
                <label class="form-label">Description</label>
                <div class="markdown-toolbar">
                    <button class="btn btn-sm" type="button" onclick="applyMarkdown('bold')">Bold</button>
                    <button class="btn btn-sm" type="button" onclick="applyMarkdown('italic')">Italic</button>
                    <button class="btn btn-sm" type="button" onclick="applyMarkdown('h1')">H1</button>
                    <button class="btn btn-sm" type="button" onclick="applyMarkdown('h2')">H2</button>
                    <button class="btn btn-sm" type="button" onclick="applyMarkdown('h3')">H3</button>
                    <button class="btn btn-sm" type="button" onclick="applyMarkdown('list')">List</button>
                    <button class="btn btn-sm" type="button" onclick="applyMarkdown('code')">Code</button>
                    <button class="btn btn-sm" type="button" onclick="applyMarkdown('link')">Link</button>
                    <button class="btn btn-sm" type="button" onclick="triggerDescriptionUpload()">Upload .md</button>
                    <input type="file" id="descUploadInput" accept=".md,.markdown,text/markdown,text/plain" style="display:none" onchange="handleDescriptionUpload(event)">
                    <div style="flex:1"></div>
                    <button class="btn btn-sm" type="button" onclick="toggleDescriptionPreview()" id="descPreviewBtn">Markdown Preview</button>
                </div>
                <textarea class="form-textarea" id="descriptionInput" placeholder="Detailed description of your service functionality, use cases, and capabilities..." oninput="handleDescriptionInput()"></textarea>
                <div id="descriptionPreview" class="markdown-preview" style="display:none;"></div>
            </div>

            <div class="form-group">
                <label class="form-label">Tags</label>
                <div class="tags-container" id="tagsContainer">
                    <div class="tag">
                        legal
                        <button class="tag-remove" onclick="removeTag(this)">√ó</button>
                    </div>
                    <div class="tag">
                        documents
                        <button class="tag-remove" onclick="removeTag(this)">√ó</button>
                    </div>
                    <div class="tag">
                        nlp
                        <button class="tag-remove" onclick="removeTag(this)">√ó</button>
                    </div>
                    <div class="tag">
                        analysis
                        <button class="tag-remove" onclick="removeTag(this)">√ó</button>
                    </div>
                </div>
                <input type="text" class="form-input" id="tagInput" placeholder="Add tags..." onkeypress="handleTagInput(event)">
                <div class="form-help">Press Enter to add tags. Tags help users discover your service.</div>
                <div class="tag-suggestions">
                    <div class="tag-suggestion" onclick="addSuggestionTag('language:english')">language:english</div>
                    <div class="tag-suggestion" onclick="addSuggestionTag('language:spanish')">language:spanish</div>
                    <div class="tag-suggestion" onclick="addSuggestionTag('priority:high')">priority:high</div>
                    <div class="tag-suggestion" onclick="addSuggestionTag('type:chat')">type:chat</div>
                    <div class="tag-suggestion" onclick="addSuggestionTag('type:search')">type:search</div>
                </div>
            </div>

           
        </div>

        <!-- Code Generation Tab -->
        <div class="tab-content" id="code-generation-tab">
            <!-- Service Type Selection -->
            <div class="form-group">
                <label class="form-label">Service Type
                    <span class="tooltip-container tooltip-hover" style="margin-left:6px;">
                        <span style="cursor: help;">‚ÑπÔ∏è</span>
                        <span class="tooltip-bubble">Data Source serves your data via RAG or search. Synthesizer merges inputs using an AI model or logic.</span>
                    </span>
                </label>
                <div class="single-choice-list">
                    <div class="single-choice-item" id="type-datasource" onclick="selectServiceType('datasource')">
                        <span class="radio-circle"></span>
                        <div class="choice-text">
                            <div class="choice-title">üóÑÔ∏è Data Source</div>
                            <div class="choice-desc">Expose your data via RAG or keyword search.</div>
                        </div>
                    </div>
                    <div class="single-choice-item" id="type-synthesizer" onclick="selectServiceType('synthesizer')">
                        <span class="radio-circle"></span>
                        <div class="choice-text">
                            <div class="choice-title">üß† Synthesizer</div>
                            <div class="choice-desc">Combine federated inputs with your own AI model or logic.</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Synthesizer Configuration (shown when synthesizer is selected) -->
            <div id="synth-config-container" class="service-config-container" style="display:none;">
                <div class="service-config-panel">
                    <div class="form-group">
                        <label class="form-label">Chat Configuration</label>
                        <div class="options-grid">
                            <div class="option-card selected" id="synth-gen-default-card" onclick="selectGenerationOption('synth','default')">
                                <div class="option-title">
                                    <input type="radio" name="synth-gen" id="synth-gen-default" checked> Default Chat
                                </div>
                                <div class="option-description">Leverages local vector DB with your chosen Ollama model.</div>
                            </div>
                            <div class="option-card" id="synth-gen-custom-card" onclick="selectGenerationOption('synth','custom')">
                                <div class="option-title">
                                    <input type="radio" name="synth-gen" id="synth-gen-custom"> Custom Chat
                                </div>
                                <div class="option-description">You will implement and provide your own chat endpoint.</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Advanced Settings -->
                    <div class="advanced-settings" id="synth-advanced-settings">
                        <div class="advanced-toggle" onclick="toggleAdvancedSettings('synth')">
                            <span class="advanced-arrow" id="synth-arrow">‚ñ∂</span>
                            <span>Advanced Settings</span>
                        </div>
                        <div class="advanced-content" id="synth-advanced-content" style="display:none;">
                            <div class="form-group">
                                <label class="form-label">Ollama Model</label>
                                <select class="form-select" id="synth-ollama-model">
                                    <option value="llama3.2:7b" selected>Llama 3.2 7B (Balanced)</option>
                                    <option value="llama3.2:3b">Llama 3.2 3B (Fast, efficient)</option>
                                    <option value="llama3.1:8b">Llama 3.1 8B (High quality)</option>
                                    <option value="mistral:7b">Mistral 7B (Code-friendly)</option>
                                    <option value="codellama:7b">Code Llama 7B (Code specialist)</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Temperature</label>
                                <div style="display:flex; gap: 12px; align-items: center;">
                                    <input type="range" id="synth-temperature" min="0" max="1" step="0.1" value="0.7" style="flex:1;" oninput="document.getElementById('synth-temperature-value').textContent=this.value">
                                    <span id="synth-temperature-value">0.7</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Available Services (for Data Source) -->
            <div id="available-services" style="display:none;">
                <div class="form-group">
                    <label class="form-label">Available Services
                        <span class="tooltip-container tooltip-hover" style="margin-left:6px;">
                            <span style="cursor: help;">‚ÑπÔ∏è</span>
                            <span class="tooltip-bubble">RAG answers with grounded citations using vector search. Search returns exact matches without LLM synthesis.</span>
                        </span>
                    </label>
                    <div class="available-services-layout">
                        <div class="service-list">
                            <div class="option-card" id="available-rag" onclick="toggleAvailableService('rag')">
                                <div class="option-title">
                                    <input type="checkbox" id="rag-available">
                                    Retrieval-Augmented Generation (RAG)
                                </div>
                                <div class="option-description">LLM synthesizes answers from your documents with citations.</div>
                            </div>
                            
                            <!-- RAG Configuration Container -->
                            <div id="rag-config-container" class="service-config-container" style="display:none;">
                                <div class="service-config-panel">
                                    <div class="form-group">
                                        <label class="form-label">RAG Configuration</label>
                                        <div class="options-grid">
                                            <div class="option-card selected" id="rag-gen-default-card" onclick="selectGenerationOption('rag','default')">
                                                <div class="option-title">
                                                    <input type="radio" name="rag-gen" id="rag-gen-default" checked> Default RAG setup
                                                </div>
                                                <div class="option-description">Leverages local vector DB with your chosen Ollama model.</div>
                                            </div>
                                            <div class="option-card" id="rag-gen-custom-card" onclick="selectGenerationOption('rag','custom')">
                                                <div class="option-title">
                                                    <input type="radio" name="rag-gen" id="rag-gen-custom"> Custom RAG
                                                </div>
                                                <div class="option-description">You will implement and provide your own RAG endpoint.</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Advanced Settings for RAG -->
                                    <div class="advanced-settings" id="rag-advanced-settings">
                                        <div class="advanced-toggle" onclick="toggleAdvancedSettings('rag')">
                                            <span class="advanced-arrow" id="rag-arrow">‚ñ∂</span>
                                            <span>Advanced Settings</span>
                                        </div>
                                        <div class="advanced-content" id="rag-advanced-content" style="display:none;">
                                            <div class="form-group">
                                                <label class="form-label">Ollama Model</label>
                                                <select class="form-select" id="rag-ollama-model">
                                                    <option value="llama3.2:7b" selected>Llama 3.2 7B (Balanced)</option>
                                                    <option value="llama3.2:3b">Llama 3.2 3B (Fast, efficient)</option>
                                                    <option value="llama3.1:8b">Llama 3.1 8B (High quality)</option>
                                                    <option value="mistral:7b">Mistral 7B (Code-friendly)</option>
                                                    <option value="codellama:7b">Code Llama 7B (Code specialist)</option>
                                                    <option value="phi3:mini">Phi-3 Mini (Lightweight)</option>
                                                    <option value="gemma2:2b">Gemma 2 2B (Fast inference)</option>
                                                    <option value="qwen2:7b">Qwen 2 7B (Multilingual)</option>
                                                </select>
                                            </div>
                                            
                                            <div class="form-group">
                                                <label class="form-label">Temperature</label>
                                                <div style="display:flex; gap: 12px; align-items: center;">
                                                    <input type="range" id="rag-temperature" min="0" max="1" step="0.1" value="0.7" style="flex:1;" oninput="document.getElementById('rag-temperature-value').textContent=this.value">
                                                    <span id="rag-temperature-value">0.7</span>
                                                </div>
                                            </div>
                                            
                                            <div class="form-group">
                                                <label class="form-label">Max Tokens</label>
                                                <input type="number" class="form-input" id="rag-max-tokens" value="1000" min="100" max="8000" step="100">
                                            </div>
                                            
                                            <div class="form-group">
                                                <label class="form-label">Top K Results</label>
                                                <input type="number" class="form-input" id="rag-top-k" value="5" min="1" max="20">
                                            </div>
                                            
                                            <div class="form-group">
                                                <label class="form-label">Similarity Threshold</label>
                                                <div style="display:flex; gap: 12px; align-items: center;">
                                                    <input type="range" id="rag-similarity" min="0" max="1" step="0.05" value="0.7" style="flex:1;" oninput="document.getElementById('rag-similarity-value').textContent=this.value">
                                                    <span id="rag-similarity-value">0.7</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- LLM Privacy Filters for RAG -->
                                    <div class="form-group" id="rag-llm-filters">
                                        <label class="form-label">
                                            LLM Privacy Filters (optional)
                                            <span class="tooltip-container tooltip-hover" style="margin-left:6px;">
                                                <span style="cursor: help;">‚ÑπÔ∏è</span>
                                                <span class="tooltip-bubble">Post-process outputs to ensure they don't expose your data in undesired ways.</span>
                                            </span>
                                        </label>
                                        <div class="filter-group">
                                            <div id="rag-output-filters-list" class="filter-tags"></div>
                                            <div style="display: flex; gap: 8px; margin-top: 8px;">
                                                <input type="text" class="form-input" placeholder="e.g., Remove employee names from output" id="rag-filter-input">
                                                <button class="btn btn-sm" onclick="addFilter('rag')">Add Filter</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="option-card" id="available-search" onclick="toggleAvailableService('search')">
                                <div class="option-title">
                                    <input type="checkbox" id="search-available">
                                    Direct Search
                                </div>
                                <div class="option-description">Returns exact chunks of your data for maximum factuality.</div>
                            </div>

                            <!-- Search Configuration Container -->
                            <div id="search-config-container" class="service-config-container" style="display:none;">
                                <div class="service-config-panel">
                                    <div class="form-group">
                                        <label class="form-label">Search Configuration</label>
                                        <div class="options-grid">
                                            <div class="option-card selected" id="search-gen-default-card" onclick="selectGenerationOption('search','default')">
                                                <div class="option-title">
                                                    <input type="radio" name="search-gen" id="search-gen-default" checked> Default Search
                                                </div>
                                                <div class="option-description">Uses semantic search across your local vector database.</div>
                                            </div>
                                            <div class="option-card" id="search-gen-custom-card" onclick="selectGenerationOption('search','custom')">
                                                <div class="option-title">
                                                    <input type="radio" name="search-gen" id="search-gen-custom"> Custom Search
                                                </div>
                                                <div class="option-description">You will implement your own /search endpoint.</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Advanced Settings for Search -->
                                    <div class="advanced-settings" id="search-advanced-settings">
                                        <div class="advanced-toggle" onclick="toggleAdvancedSettings('search')">
                                            <span class="advanced-arrow" id="search-arrow">‚ñ∂</span>
                                            <span>Advanced Settings</span>
                                        </div>
                                        <div class="advanced-content" id="search-advanced-content" style="display:none;">
                                            <div class="form-group">
                                                <label class="form-label">Max Results</label>
                                                <input type="number" class="form-input" id="search-max-results" value="10" min="1" max="100">
                                            </div>
                                            
                                        </div>
                                    </div>
                                    
                                    
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Generate Code Button -->
            <div class="generate-actions" id="generate-code-actions">
                <button class="btn btn-primary btn-large" id="generateActionButton" onclick="generateServiceCode()">Generate Code</button>
            </div>
        </div>

        <!-- Manage Control Tab -->
        <div class="tab-content" id="access-control-tab">
            <!-- Service Type Indicator -->
            <div class="service-type-indicator">
                <div class="indicator-label">Service Type:</div>
                <div class="indicator-value" id="access-control-service-type">Data Source</div>
            </div>

            <!-- Service Access Control -->
            <div class="access-control-section">
                <div class="section-title">Service Manage Control</div>
                <div class="form-help" style="margin-bottom: 16px;">
                    Configure who can access and use this service.
                </div>
                
                <div class="form-group">
                    <label class="form-label">Service Users</label>
                    <div class="service-users-grid">
                        <input type="email" class="form-input" placeholder="User email..." id="service-user-email">
                        <select class="form-select" id="service-user-access">
                            <option value="full">Full Access</option>
                            <option value="read">Read Only</option>
                            <option value="query">Query Only</option>
                        </select>
                        <button class="btn btn-primary" onclick="addServiceUser()">Add User</button>
                    </div>
                    <div class="service-users-list" id="service-users-list"></div>
                </div>
            </div>

            <!-- Data Source Specific: Watched Files -->
            <div class="access-control-section" id="watched-files-section">
                <div class="section-title">Watched Files/Folders</div>
                <div class="form-help" style="margin-bottom: 16px;">
                    Configure which files and folders this service can access, and who has access to each resource.
                </div>
                
                <table class="watched-files-table">
                    <thead>
                        <tr>
                            <th>Path</th>
                            <th>Date Added</th>
                            <th>Allowed to Query</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="watched-files-tbody">
                        <tr>
                            <td class="path-cell">/data/legal-documents/</td>
                            <td>2024-01-15</td>
                            <td>
                                <span class="user-badge">admin@lexfirm.eu</span>
                                <span class="user-badge">analyst@lexfirm.eu</span>
                                <button class="btn btn-primary" style="padding: 4px 8px; font-size: 12px; margin-left: 8px;" onclick="showAddUserModal('/data/legal-documents/')">+</button>
                            </td>
                            <td>
                                <button class="btn btn-remove">Remove</button>
                            </td>
                        </tr>
                        <tr>
                            <td class="path-cell">/data/contracts/</td>
                            <td>2024-01-10</td>
                            <td>
                                <span class="user-badge">admin@lexfirm.eu</span>
                                <span class="user-badge">senior.partner@lexfirm.eu</span>
                                <button class="btn btn-primary" style="padding: 4px 8px; font-size: 12px; margin-left: 8px;" onclick="showAddUserModal('/data/contracts/')">+</button>
                            </td>
                            <td>
                                <button class="btn btn-remove">Remove</button>
                            </td>
                        </tr>
                        <tr>
                            <td class="path-cell">/docs/public-guidelines.pdf</td>
                            <td>2024-01-05</td>
                            <td>
                                <span style="color: #059669; font-size: 13px;">‚úì Everyone</span>
                                <button class="btn btn-primary" style="padding: 4px 8px; font-size: 12px; margin-left: 8px;" onclick="showAddUserModal('/docs/public-guidelines.pdf')">+</button>
                            </td>
                            <td>
                                <button class="btn btn-remove">Remove</button>
                            </td>
                        </tr>
                    </tbody>
                </table>

                <div class="add-path-form">
                    <input type="text" class="form-input" id="new-path-input" placeholder="Add new path to watch...">
                    <button class="btn" onclick="browsePath()">Browse Path</button>
                    <button class="btn btn-primary" onclick="addNewPath()">Add Path</button>
                    <input type="file" id="path-browser" style="display: none;" onchange="handlePathSelection(event)" webkitdirectory>
                </div>
            </div>

            <!-- Collective Membership -->
            <div class="access-control-section">
                <div class="section-title">Collective Membership</div>
                <div class="form-help" style="margin-bottom: 16px;">
                    Join a collective to inherit shared policies and gain access to collective resources.
                </div>
                
                <div class="form-group">
                    <label class="form-label">Select Collective</label>
                    <select class="form-select" id="collective-select">
                        <option value="">Independent (No collective)</option>
                        <option value="legal-ai">Legal AI Collective</option>
                        <option value="healthcare-ai">Healthcare AI Collective</option>
                        <option value="finance-ai">Finance AI Collective</option>
                    </select>
                </div>

                <div class="collective-policies" id="collective-policies" style="display: none;">
                    <div style="font-size: 14px; font-weight: 600; color: #1e293b;">Inherited Policies</div>
                    <div class="policy-grid">
                        <div class="policy-item">
                            <input type="checkbox" id="unified-routing" checked disabled>
                            <label for="unified-routing">Unified Routing</label>
                            <span class="policy-status">Enabled by collective</span>
                        </div>
                        <div class="policy-item">
                            <input type="checkbox" id="pricing-delegation" checked disabled>
                            <label for="pricing-delegation">Pricing Delegation</label>
                            <span class="policy-status">Enabled by collective</span>
                        </div>
                        <div class="policy-item">
                            <input type="checkbox" id="access-delegation" disabled>
                            <label for="access-delegation">Manage Control Delegation</label>
                            <span class="policy-status">Disabled by collective</span>
                        </div>
                        <div class="policy-item">
                            <input type="checkbox" id="paywall-disabled">
                            <label for="paywall-disabled">Disable Paywall</label>
                            <span class="policy-status">User configurable</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="codeGenModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Generated Service Code</h3>
                <button class="modal-close" onclick="closeModal('codeGenModal')">√ó</button>
            </div>
            <div class="modal-body">
                <p>Your service code has been generated successfully!</p>
                <pre style="background: #f8fafc; padding: 16px; border-radius: 8px; overflow-x: auto;">
# Service configuration generated
service_id: irina@openmined.org/legal_document_analyzer
type: datasource
status: ready
                </pre>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div class="modal-overlay" id="addUserModal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Add User Access</h3>
                <button class="modal-close" onclick="closeModal('addUserModal')">√ó</button>
            </div>
            <div class="modal-body">
                <p id="addUserPath" style="font-size: 13px; color: #64748b; margin-bottom: 16px;"></p>
                <div class="form-group">
                    <label class="form-label">User Email</label>
                    <input type="email" class="form-input" id="addUserEmail" placeholder="user@example.com">
                </div>
                <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px;">
                    <button class="btn" onclick="closeModal('addUserModal')">Cancel</button>
                    <button class="btn btn-primary" onclick="addUserToPath()">Add User</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Payment Registration Modal -->
    <div class="modal-overlay" id="paymentRegistrationModal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Register Wallet Manager</h3>
                <button class="modal-close" onclick="closeModal('paymentRegistrationModal')">√ó</button>
            </div>
            <div class="modal-body">
                <!-- Step 1: Service Selection -->
                <div class="payment-modal-step active" id="paymentStep1">
                    <div class="form-group">
                        <label class="form-label">Select Wallet Manager</label>
                        <div class="service-option" onclick="selectPaymentService('openmined')">
                            <input type="radio" name="paymentService" value="openmined" id="openmined-radio">
                            <div class="service-details">
                                <div class="service-name">OpenMined Wallet Manager</div>
                                <div class="service-url">https://payments.openmined.org</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        <input type="email" class="form-input" id="paymentEmail" placeholder="Your email address" readonly>
                        <div class="form-help">This email is prefilled from your profile</div>
                    </div>
                    
                    <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px;">
                        <button class="btn" onclick="closeModal('paymentRegistrationModal')">Cancel</button>
                        <button class="btn btn-primary" onclick="proceedToPasswordStep()" id="proceedBtn" disabled>Next</button>
                    </div>
                </div>
                
                <!-- Step 2: Password Setup -->
                <div class="payment-modal-step" id="paymentStep2">
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-input" id="paymentPassword" placeholder="Create a password">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Confirm Password</label>
                        <input type="password" class="form-input" id="paymentPasswordConfirm" placeholder="Confirm your password">
                        <div class="payment-error" id="passwordError">Passwords do not match</div>
                    </div>
                    
                    <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px;">
                        <button class="btn" onclick="goBackToServiceSelection()">Back</button>
                        <button class="btn btn-primary" onclick="completePaymentRegistration()">Complete Registration</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Payment Required Modal -->
    <div class="modal-overlay" id="paymentRequiredModal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Wallet Manager Required</h3>
                <button class="modal-close" onclick="closeModal('paymentRequiredModal')">√ó</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 16px;">This service requires payment. You must register with a wallet manager to access paid services.</p>
                <div style="display: flex; gap: 8px; justify-content: flex-end;">
                    <button class="btn" onclick="closeModal('paymentRequiredModal')">Cancel</button>
                    <button class="btn btn-primary" onclick="closeModal('paymentRequiredModal'); showPaymentRegistration();">Register Wallet Manager</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let selectedServiceType = null;
        let selectedAvailable = { rag: false, search: false };
        let generationChoices = { rag: null, search: null, synth: null };
        
        // Centralized User Account Management System
        class UserAccountManager {
            constructor() {
                this.storageKey = 'userAccountData';
                this.walletStorageKey = 'walletManagerData'; // Separate storage for wallet data
                this.defaultAccount = {
                    email: 'guest@syft.org',
                    name: 'Guest',
                    paymentService: null
                    // Note: balance is not set by default - only when wallet manager is registered
                };
                this.account = this.loadAccount();
                this.loadWalletData(); // Load wallet data separately
            }
            
            loadAccount() {
                try {
                    const stored = localStorage.getItem(this.storageKey);
                    if (stored) {
                        const parsedAccount = JSON.parse(stored);
                        return { ...this.defaultAccount, ...parsedAccount };
                    }
                } catch (e) {
                    console.warn('Failed to load user account from localStorage:', e);
                }
                return { ...this.defaultAccount };
            }
            
            loadWalletData() {
                try {
                    const walletData = localStorage.getItem(this.walletStorageKey);
                    if (walletData) {
                        const parsed = JSON.parse(walletData);
                        this.account.paymentService = parsed.paymentService;
                        this.account.balance = parsed.balance;
                    }
                } catch (e) {
                    console.warn('Failed to load wallet data from localStorage:', e);
                }
            }
            
            saveWalletData() {
                try {
                    const walletData = {
                        paymentService: this.account.paymentService,
                        balance: this.account.balance
                    };
                    localStorage.setItem(this.walletStorageKey, JSON.stringify(walletData));
                } catch (e) {
                    console.warn('Failed to save wallet data to localStorage:', e);
                }
            }
            
            saveAccount() {
                try {
                    localStorage.setItem(this.storageKey, JSON.stringify(this.account));
                } catch (e) {
                    console.warn('Failed to save user account to localStorage:', e);
                }
            }
            
            updateAccount(updates) {
                this.account = { ...this.account, ...updates };
                this.saveAccount();
                this.broadcastAccountUpdate();
            }
            
            broadcastAccountUpdate() {
                window.dispatchEvent(new CustomEvent('userAccountUpdated', { 
                    detail: this.account 
                }));
            }
            
            getAccount() {
                return { ...this.account };
            }
            
            registerPaymentService(provider, url) {
                this.account.paymentService = {
                    provider,
                    url,
                    registeredAt: new Date().toISOString()
                };
                this.account.balance = '$87.20'; // Set balance when wallet manager is registered
                
                // Save wallet data separately (persists across user changes)
                this.saveWalletData();
                
                // Also update account and broadcast
                this.saveAccount();
                this.broadcastAccountUpdate();
            }
            
            updateAuthenticatedUser(email) {
                // Only update email/name if different
                if (this.account.email !== email) {
                    this.account.email = email;
                    this.account.name = email.split('@')[0];
                    
                    // Always reload wallet data (persists across users)
                    this.loadWalletData();
                    
                    this.saveAccount();
                    this.broadcastAccountUpdate();
                }
            }
            
            isLoggedIn() {
                return this.account.email !== 'guest@syft.org';
            }
            
            hasPaymentService() {
                return this.account.paymentService !== null;
            }
        }
        
        // Global account manager instance
        const accountManager = new UserAccountManager();
        
        // Set default user for service-edit (authenticated user context)
        if (accountManager.getAccount().email === 'guest@syft.org') {
            accountManager.updateAuthenticatedUser('irina@openmined.org');
        }
        
        // Legacy userAccount object for backward compatibility
        let userAccount = accountManager.getAccount();

        // Tab switching
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Add active to selected button
            event.target.classList.add('active');
        }

        // Service Type Selection
        function selectServiceType(type) {
            selectedServiceType = type;
            
            // Reset choices when switching types
            selectedAvailable = { rag: false, search: false };
            generationChoices = { rag: null, search: null, synth: null };
            
            // Update UI selection
            document.getElementById('type-datasource').classList.toggle('selected', type === 'datasource');
            document.getElementById('type-synthesizer').classList.toggle('selected', type === 'synthesizer');
            
            // Toggle sections
            document.getElementById('available-services').style.display = (type === 'datasource') ? 'block' : 'none';
            document.getElementById('synth-config-container').style.display = (type === 'synthesizer') ? 'block' : 'none';
            
            // Set default for synthesizer
            if (type === 'synthesizer') {
                generationChoices.synth = 'default';
            }
            
            // Update access control indicator
            const indicator = document.getElementById('access-control-service-type');
            if (indicator) {
                if (type === 'datasource') {
                    indicator.textContent = 'Data Source';
                    indicator.style.background = '#dbeafe';
                    indicator.style.color = '#1d4ed8';
                } else if (type === 'synthesizer') {
                    indicator.textContent = 'Synthesizer';
                    indicator.style.background = '#dcfce7';
                    indicator.style.color = '#16a34a';
                }
            }
            
            // Update generate button
            updateGenerateButton();
        }

        // Toggle Available Service
        function toggleAvailableService(service) {
            selectedAvailable[service] = !selectedAvailable[service];
            
            const card = document.getElementById(`available-${service}`);
            const checkbox = document.getElementById(`${service}-available`);
            const container = document.getElementById(`${service}-config-container`);
            
            if (selectedAvailable[service]) {
                card.classList.add('selected');
                checkbox.checked = true;
                container.style.display = 'block';
                // Set default choice when enabling service
                generationChoices[service] = 'default';
            } else {
                card.classList.remove('selected');
                checkbox.checked = false;
                container.style.display = 'none';
                // Reset choice when disabling service
                generationChoices[service] = null;
            }
            
            // Update generate button
            updateGenerateButton();
        }

        // Select Generation Option
        function selectGenerationOption(service, option) {
            generationChoices[service] = option;
            
            // Update UI
            document.getElementById(`${service}-gen-default-card`).classList.toggle('selected', option === 'default');
            document.getElementById(`${service}-gen-custom-card`).classList.toggle('selected', option === 'custom');
            document.getElementById(`${service}-gen-default`).checked = (option === 'default');
            document.getElementById(`${service}-gen-custom`).checked = (option === 'custom');
            
            // Show/hide advanced settings based on selection
            const advancedSettings = document.getElementById(`${service}-advanced-settings`);
            const llmFilters = document.getElementById(`${service}-llm-filters`) || document.getElementById(`${service}-filters`);
            
            if (option === 'custom') {
                // Hide advanced settings for custom implementations
                if (advancedSettings) {
                    advancedSettings.style.display = 'none';
                }
                if (llmFilters) {
                    llmFilters.style.display = 'none';
                }
            } else {
                // Show advanced settings for default implementations
                if (advancedSettings) {
                    advancedSettings.style.display = 'block';
                }
                if (llmFilters) {
                    llmFilters.style.display = 'block';
                }
            }
            
            // Update generate button
            updateGenerateButton();
        }

        // Toggle Advanced Settings
        function toggleAdvancedSettings(service) {
            const content = document.getElementById(`${service}-advanced-content`);
            const arrow = document.getElementById(`${service}-arrow`);
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                arrow.classList.add('expanded');
            } else {
                content.style.display = 'none';
                arrow.classList.remove('expanded');
            }
        }

        // Markdown Functions
        function applyMarkdown(type) {
            const textarea = document.getElementById('descriptionInput');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            const selectedText = text.substring(start, end);
            
            let replacement = '';
            switch(type) {
                case 'bold':
                    replacement = `**${selectedText || 'bold text'}**`;
                    break;
                case 'italic':
                    replacement = `*${selectedText || 'italic text'}*`;
                    break;
                case 'h1':
                    replacement = `# ${selectedText || 'Heading 1'}`;
                    break;
                case 'h2':
                    replacement = `## ${selectedText || 'Heading 2'}`;
                    break;
                case 'h3':
                    replacement = `### ${selectedText || 'Heading 3'}`;
                    break;
                case 'list':
                    replacement = `- ${selectedText || 'List item'}`;
                    break;
                case 'code':
                    replacement = `\`${selectedText || 'code'}\``;
                    break;
                case 'link':
                    replacement = `[${selectedText || 'link text'}](url)`;
                    break;
            }
            
            textarea.value = text.substring(0, start) + replacement + text.substring(end);
            textarea.focus();
            textarea.setSelectionRange(start, start + replacement.length);
            handleDescriptionInput();
        }

        function toggleDescriptionPreview() {
            const preview = document.getElementById('descriptionPreview');
            const btn = document.getElementById('descPreviewBtn');
            const textarea = document.getElementById('descriptionInput');
            
            if (preview.style.display === 'none') {
                preview.style.display = 'block';
                textarea.style.display = 'none';
                btn.textContent = 'Edit Markdown';
                updateDescriptionPreview();
            } else {
                preview.style.display = 'none';
                textarea.style.display = 'block';
                btn.textContent = 'Markdown Preview';
            }
        }

        function handleDescriptionInput() {
            if (document.getElementById('descriptionPreview').style.display !== 'none') {
                updateDescriptionPreview();
            }
        }

        function updateDescriptionPreview() {
            const textarea = document.getElementById('descriptionInput');
            const preview = document.getElementById('descriptionPreview');
            // Simple markdown to HTML conversion
            let html = textarea.value
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/### (.*?)$/gm, '<h3>$1</h3>')
                .replace(/## (.*?)$/gm, '<h2>$1</h2>')
                .replace(/# (.*?)$/gm, '<h1>$1</h1>')
                .replace(/- (.*?)$/gm, '<li>$1</li>')
                .replace(/`(.*?)`/g, '<code>$1</code>')
                .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>')
                .replace(/\n/g, '<br>');
            preview.innerHTML = html || '<em>No content to preview</em>';
        }

        function triggerDescriptionUpload() {
            document.getElementById('descUploadInput').click();
        }

        function handleDescriptionUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('descriptionInput').value = e.target.result;
                    handleDescriptionInput();
                };
                reader.readAsText(file);
            }
        }

        // Tag Functions
        function handleTagInput(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const input = document.getElementById('tagInput');
                const tag = input.value.trim();
                if (tag) {
                    addTag(tag);
                    input.value = '';
                }
            }
        }

        function addTag(tagText) {
            const container = document.getElementById('tagsContainer');
            const tagDiv = document.createElement('div');
            tagDiv.className = 'tag';
            tagDiv.innerHTML = `
                ${tagText}
                <button class="tag-remove" onclick="removeTag(this)">√ó</button>
            `;
            container.appendChild(tagDiv);
        }

        function removeTag(button) {
            button.parentElement.remove();
        }

        function addSuggestionTag(tagText) {
            addTag(tagText);
        }

        // Update Generate Button based on selections
        function updateGenerateButton() {
            const button = document.getElementById('generateActionButton');
            if (!button) return;
            
            let hasValidConfig = false;
            let hasCustomConfig = false;
            
            // Check synthesizer configuration
            if (selectedServiceType === 'synthesizer') {
                if (generationChoices.synth === 'default') {
                    hasValidConfig = true;
                } else if (generationChoices.synth === 'custom') {
                    hasCustomConfig = true;
                }
            }
            
            // Check data source configuration
            if (selectedServiceType === 'datasource') {
                if (selectedAvailable.rag || selectedAvailable.search) {
                    if ((selectedAvailable.rag && generationChoices.rag === 'default') ||
                        (selectedAvailable.search && generationChoices.search === 'default')) {
                        hasValidConfig = true;
                    }
                    if ((selectedAvailable.rag && generationChoices.rag === 'custom') ||
                        (selectedAvailable.search && generationChoices.search === 'custom')) {
                        hasCustomConfig = true;
                    }
                }
            }
            
            // Update button text and state
            if (hasValidConfig && !hasCustomConfig) {
                button.textContent = 'Generate AI Service';
                button.disabled = false;
                button.style.opacity = '1';
                button.style.cursor = 'pointer';
            } else if (hasCustomConfig || (selectedServiceType && (selectedAvailable.rag || selectedAvailable.search || selectedServiceType === 'synthesizer'))) {
                button.textContent = 'Generate Template Service Code';
                button.disabled = true;
                button.style.opacity = '0.5';
                button.style.cursor = 'not-allowed';
            } else {
                button.textContent = 'Generate Service Code';
                button.disabled = true;
                button.style.opacity = '0.5';
                button.style.cursor = 'not-allowed';
            }
        }

        // Add Filter
        function addFilter(service) {
            const input = document.getElementById(`${service}-filter-input`);
            const filterText = input.value.trim();
            if (!filterText) return;
            
            const filtersList = document.getElementById(`${service}-output-filters-list`);
            const filterTag = document.createElement('div');
            filterTag.className = 'filter-tag';
            filterTag.innerHTML = `
                ${filterText}
                <button class="filter-tag-remove" onclick="removeFilter(this)">√ó</button>
            `;
            
            filtersList.appendChild(filterTag);
            input.value = '';
        }

        // Remove Filter
        function removeFilter(button) {
            button.parentElement.remove();
        }

        // Generate Service Code
        function generateServiceCode() {
            // Check if any paid services are being used
            if (selectedServiceType === 'synthesizer' && generationChoices.synth === 'default') {
                const selectedModel = document.getElementById('synth-ollama-model')?.value || 'llama3.2:7b';
                if (!checkPaidServiceAccess(selectedModel)) {
                    return; // Don't proceed if payment is required but not set up
                }
            }
            
            if (selectedServiceType === 'datasource') {
                if (selectedAvailable.rag && generationChoices.rag === 'default') {
                    const selectedModel = document.getElementById('rag-ollama-model')?.value || 'llama3.2:7b';
                    if (!checkPaidServiceAccess(selectedModel)) {
                        return;
                    }
                }
            }
            
            const button = document.getElementById('generateActionButton');
            const originalText = button.innerHTML;
            
            // Show loading state
            button.innerHTML = '‚è≥ Generating...';
            button.disabled = true;
            
            // Simulate code generation
            setTimeout(() => {
                button.innerHTML = '‚úÖ Code Generated!';
                button.style.background = '#16a34a';
                
                // Show success modal
                alert('Service code generated successfully!\n\nYour service is now ready to be published.');
                
                // Reset button after delay
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.disabled = false;
                    button.style.background = '';
                    updateGenerateButton(); // Reset to proper state
                }, 2000);
            }, 2000);
        }

        // Add service user
        function addServiceUser() {
            const emailInput = document.getElementById('service-user-email');
            const accessSelect = document.getElementById('service-user-access');
            const usersList = document.getElementById('service-users-list');
            
            if (!emailInput.value) return;
            
            const userItem = document.createElement('div');
            userItem.className = 'service-user-item';
            userItem.innerHTML = `
                <div>
                    <div class="service-user-email">${emailInput.value}</div>
                    <div class="service-user-access">${accessSelect.value}</div>
                </div>
                <button class="btn btn-remove" onclick="this.parentElement.remove()">Remove</button>
            `;
            
            usersList.appendChild(userItem);
            emailInput.value = '';
        }

        // Navigation
        function goBack() {
            window.location.href = 'build.html';
        }

        // Publish service
        function publishService() {
            if (confirm('Are you ready to publish this service?')) {
                document.getElementById('serviceStatus').textContent = 'Published ‚Ä¢ Live';
                document.getElementById('publishBtn').textContent = '‚úÖ Published';
                document.getElementById('publishBtn').disabled = true;
                document.getElementById('generateMCPBtn').disabled = false;
                alert('Service published successfully!');
            }
        }

        // Generate MCP Tool
        function generateMCPTool() {
            alert('MCP Tool generated successfully!\n\nYour tool configuration has been created and is ready for integration.');
        }

        // Show Add User Modal
        let currentPath = '';
        function showAddUserModal(path) {
            currentPath = path;
            document.getElementById('addUserPath').textContent = `Adding access for: ${path}`;
            document.getElementById('addUserEmail').value = '';
            document.getElementById('addUserModal').style.display = 'flex';
        }

        // Add User to Path
        function addUserToPath() {
            const email = document.getElementById('addUserEmail').value.trim();
            if (!email) {
                alert('Please enter a valid email address');
                return;
            }
            
            // Find the row with the current path and add the user badge
            const rows = document.querySelectorAll('#watched-files-tbody tr');
            rows.forEach(row => {
                const pathCell = row.querySelector('.path-cell');
                if (pathCell && pathCell.textContent === currentPath) {
                    const queryCell = row.cells[2];
                    const plusButton = queryCell.querySelector('button');
                    
                    // Create new user badge
                    const userBadge = document.createElement('span');
                    userBadge.className = 'user-badge';
                    userBadge.textContent = email;
                    
                    // Insert before the + button
                    queryCell.insertBefore(userBadge, plusButton);
                }
            });
            
            closeModal('addUserModal');
            alert(`Added ${email} to ${currentPath}`);
        }

        // Browse Path functionality
        function browsePath() {
            document.getElementById('path-browser').click();
        }

        function handlePathSelection(event) {
            const files = event.target.files;
            if (files.length > 0) {
                // Get the directory path from the first file
                const path = files[0].webkitRelativePath;
                const folderPath = '/' + path.split('/')[0] + '/';
                document.getElementById('new-path-input').value = folderPath;
            }
        }

        function addNewPath() {
            const pathInput = document.getElementById('new-path-input');
            const path = pathInput.value.trim();
            if (!path) {
                alert('Please enter or select a path');
                return;
            }
            
            // Add new row to the table
            const tbody = document.getElementById('watched-files-tbody');
            const newRow = document.createElement('tr');
            const currentDate = new Date().toISOString().split('T')[0];
            
            newRow.innerHTML = `
                <td class="path-cell">${path}</td>
                <td>${currentDate}</td>
                <td>
                    <span style="color: #059669; font-size: 13px;">‚úì Everyone</span>
                    <button class="btn btn-primary" style="padding: 4px 8px; font-size: 12px; margin-left: 8px;" onclick="showAddUserModal('${path}')">+</button>
                </td>
                <td>
                    <button class="btn btn-remove">Remove</button>
                </td>
            `;
            
            tbody.appendChild(newRow);
            pathInput.value = '';
            alert(`Added path: ${path}`);
        }

        // Close modal
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Account Menu Functions
        function toggleAccountMenu() {
            const dropdown = document.getElementById('accountDropdown');
            dropdown.classList.toggle('show');
        }
        
        // Close account menu when clicking outside
        document.addEventListener('click', function(event) {
            const accountMenu = document.querySelector('.account-menu');
            if (!accountMenu.contains(event.target)) {
                document.getElementById('accountDropdown').classList.remove('show');
            }
        });
        
        // Wallet Manager Registration Functions
        function showPaymentRegistration() {
            document.getElementById('accountDropdown').classList.remove('show');
            document.getElementById('paymentEmail').value = userAccount.email;
            document.getElementById('paymentRegistrationModal').style.display = 'flex';
            resetPaymentModal();
        }
        
        function selectPaymentService(service) {
            document.getElementById('openmined-radio').checked = true;
            document.getElementById('proceedBtn').disabled = false;
        }
        
        function proceedToPasswordStep() {
            document.getElementById('paymentStep1').classList.remove('active');
            document.getElementById('paymentStep2').classList.add('active');
        }
        
        function goBackToServiceSelection() {
            document.getElementById('paymentStep2').classList.remove('active');
            document.getElementById('paymentStep1').classList.add('active');
        }
        
        function validatePasswords() {
            const password = document.getElementById('paymentPassword').value;
            const confirmPassword = document.getElementById('paymentPasswordConfirm').value;
            const errorDiv = document.getElementById('passwordError');
            
            if (password && confirmPassword && password !== confirmPassword) {
                errorDiv.style.display = 'block';
                return false;
            } else {
                errorDiv.style.display = 'none';
                return true;
            }
        }
        
        function completePaymentRegistration() {
            const password = document.getElementById('paymentPassword').value;
            const confirmPassword = document.getElementById('paymentPasswordConfirm').value;
            
            if (!password || !confirmPassword) {
                alert('Please fill in all required fields.');
                return;
            }
            
            if (!validatePasswords()) {
                return;
            }
            
            // Register wallet manager using account manager
            accountManager.registerPaymentService('OpenMined Wallet Manager', 'https://payments.openmined.org');
            
            // Update local userAccount object for immediate UI update
            userAccount = accountManager.getAccount();
            
            updatePaymentStatus();
            closeModal('paymentRegistrationModal');
            alert('Payment service registration completed successfully!');
        }
        
        function updatePaymentStatus() {
            // Get fresh account data
            userAccount = accountManager.getAccount();
            
            const paymentStatus = document.getElementById('paymentStatus');
            const registerBtn = document.getElementById('registerPaymentBtn');
            const manageBtn = document.getElementById('managePaymentBtn');
            const accountName = document.getElementById('accountName');
            
            // Update account name display
            if (accountName) {
                accountName.textContent = userAccount.name || userAccount.email.split('@')[0];
            }
            
            const hasPaymentService = accountManager.hasPaymentService();
            
            if (hasPaymentService) {
                if (paymentStatus) {
                    paymentStatus.textContent = 'Registered';
                    paymentStatus.classList.add('registered');
                }
                if (registerBtn) registerBtn.style.display = 'none';
                if (manageBtn) manageBtn.style.display = 'flex';
            } else {
                if (paymentStatus) {
                    paymentStatus.textContent = 'Not registered';
                    paymentStatus.classList.remove('registered');
                }
                if (registerBtn) registerBtn.style.display = 'flex';
                if (manageBtn) manageBtn.style.display = 'none';
            }
        }
        
        function managePaymentService() {
            document.getElementById('accountDropdown').classList.remove('show');
            alert(`Manage your ${userAccount.paymentService.provider} account\n\nRegistered: ${new Date(userAccount.paymentService.registeredAt).toLocaleDateString()}\nService URL: ${userAccount.paymentService.url}`);
        }
        
        function resetPaymentModal() {
            document.getElementById('paymentStep1').classList.add('active');
            document.getElementById('paymentStep2').classList.remove('active');
            document.getElementById('paymentPassword').value = '';
            document.getElementById('paymentPasswordConfirm').value = '';
            document.getElementById('passwordError').style.display = 'none';
            document.getElementById('openmined-radio').checked = false;
            document.getElementById('proceedBtn').disabled = true;
        }
        
        // Paid Service Validation
        function checkPaidServiceAccess(serviceName) {
            // Example list of paid services - in a real app this would come from the service configuration
            const paidServices = ['gpt-4-turbo', 'claude-3-opus', 'gemini-pro'];
            
            if (paidServices.some(service => serviceName.toLowerCase().includes(service))) {
                if (!userAccount.paymentService) {
                    showPaymentRequiredModal();
                    return false;
                }
            }
            return true;
        }
        
        function showPaymentRequiredModal() {
            document.getElementById('paymentRequiredModal').style.display = 'flex';
        }
        
        // Add password validation listeners
        document.addEventListener('DOMContentLoaded', function() {
            const passwordInput = document.getElementById('paymentPassword');
            const confirmInput = document.getElementById('paymentPasswordConfirm');
            
            if (passwordInput && confirmInput) {
                passwordInput.addEventListener('input', validatePasswords);
                confirmInput.addEventListener('input', validatePasswords);
            }
            
            // Listen for account updates from other pages
            window.addEventListener('userAccountUpdated', function(event) {
                userAccount = event.detail;
                updatePaymentStatus();
            });
            
            // Initialize payment status
            updatePaymentStatus();
        });
        
        // Collective select handler
        document.getElementById('collective-select').addEventListener('change', function() {
            const policies = document.getElementById('collective-policies');
            if (this.value) {
                policies.style.display = 'block';
            } else {
                policies.style.display = 'none';
            }
        });
    </script>
</body>
</html>